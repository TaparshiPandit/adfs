<p>How to Utilize a Single Claims Relying Party Trust for Multiple Claims Web Applications</p>
<ol>
<li>Create a central claims aware App for example - <a href="https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fmyclaims.bme.local%2Fcentralclaims%2F&amp;data=02%7C01%7Ctapand%40microsoft.com%7Cad40ea0f11d049d0ba4b08d7eb89f65f%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637236850085912598&amp;sdata=CTsTC8gLPAgjjsNVCpKB9G2KQZyekFjxoVlKQuPFils%3D&amp;reserved=0">https://myclaims.bme.local/centralclaims/</a> . This App will sit between other claims aware Apps and ADFS and handle the redirects. Its also claims aware.</li>
<li>Add the <a href="https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fmyclaims.bme.local%2Fcentralclaims%2F&amp;data=02%7C01%7Ctapand%40microsoft.com%7Cad40ea0f11d049d0ba4b08d7eb89f65f%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637236850085922592&amp;sdata=xqOaQazdin6muhXQqDQAbaJGfcHIR8L%2BDu6XsEOoLgs%3D&amp;reserved=0">https://myclaims.bme.local/centralclaims/</a> App as an RP to ADFS and populate WS-Fed and SAML POST endpoints pointing to the Identifier of the App. i.e. <a href="https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fmyclaims.bme.local%2Fcentralclaims%2F&amp;data=02%7C01%7Ctapand%40microsoft.com%7Cad40ea0f11d049d0ba4b08d7eb89f65f%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637236850085922592&amp;sdata=xqOaQazdin6muhXQqDQAbaJGfcHIR8L%2BDu6XsEOoLgs%3D&amp;reserved=0">https://myclaims.bme.local/centralclaims/</a></li>
</ol>
<ol start="3">
<li>Decorate the Default.aspx.cs file with the following &ndash;</li>
</ol>
<p>//-----------------------------------------------------------------------------</p>
<p>//</p>
<p>// THIS CODE AND INFORMATION IS PROVIDED "AS IS" WITHOUT WARRANTY OF</p>
<p>// ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO</p>
<p>// THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A</p>
<p>// PARTICULAR PURPOSE.</p>
<p>//</p>
<p>// Copyright (c) Microsoft Corporation. All rights reserved.</p>
<p>//</p>
<p>//</p>
<p>//-----------------------------------------------------------------------------</p>
<p>using System;</p>
<p>using System.Web.UI;</p>
<p>using System.Web.UI.WebControls;</p>
<p>using Microsoft.IdentityModel.Claims;</p>
<p>public partial class _Default : System.Web.UI.Page</p>
<p>{</p>
<p>protected void Page_Load(object sender, EventArgs e)</p>
<p>{</p>
<p>string RelyingParty;</p>
<p>string Endpoint;</p>
<p>RelyingParty = Request.QueryString["RelyingParty"];</p>
<p>if (Request.HttpMethod == "GET")</p>
<p>{</p>
<p>if (RelyingParty == "prod")</p>
<p>{</p>
<p>Endpoint = "<a href="https://myclaims.bme.local/capass/">https://myclaims.bme.local/capass/</a>";</p>
<p>}</p>
<p>else if (RelyingParty == "stage")</p>
<p>{</p>
<p>Endpoint = "<a href="https://myclaims.bme.local/claimsApp2/">https://myclaims.bme.local/claimsApp2/</a>";</p>
<p>}</p>
<p>else</p>
<p>{</p>
<p>Endpoint = "<a href="https://3rd-Application-endpoint/">https://3rd-Application-endpoint/</a>";</p>
<p>}</p>
<p>Response.Cookies["Endpoint"].Value = Endpoint;</p>
<p>Response.Redirect("<a href="https://azr.sts.msidentity.com/adfs/ls/IdpInitiatedSignOn.aspx?LoginToRP=https://myclaims.bme.local/centralclaims">https://azr.sts.msidentity.com/adfs/ls/IdpInitiatedSignOn.aspx?LoginToRP=https://myclaims.bme.local/centralclaims</a>");</p>
<p>}</p>
<p>else if (Request.HttpMethod == "POST")</p>
<p>{</p>
<p>if (Request.Cookies["Endpoint"].Value is object)</p>
<p>{</p>
<p>Endpoint = Request.Cookies["Endpoint"].Value;</p>
<p>Response.ClearContent();</p>
<p>Response.StatusCode = 307;</p>
<p>Response.StatusDescription = "Temporary Redirect";</p>
<p>Response.RedirectLocation = ResolveClientUrl(Endpoint);</p>
<p>Response.Flush();</p>
<p>}</p>
<p>}</p>
<p>else</p>
<p>{</p>
<p>Response.Write("The requested HTTP method (" + Request.HttpMethod + ") is not supported by this redirector page. This page supports HTTP GET and POST. Please contact your administrator.");</p>
<p>}</p>
<p>}</p>
<p>}</p>
<p>//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</p>
<ol start="4">
<li>On the new claims aware app make the following changes in web.config. i.e. replace the default audienceUris And realm to point to the central app , rather than their own.</li>
</ol>
<p>&lt;audienceUris&gt;</p>
<p>&lt;!--&lt;add value="<a href="https://myclaims.bme.local/CAPASS/">https://myclaims.bme.local/CAPASS/</a>" /&gt;--&gt; ---- &gt; remove the default.</p>
<p>&lt;!--Updated to pint to centralclaims RP identifier--&gt;</p>
<p>&lt;add value="<a href="https://myclaims.bme.local/centralclaims/">https://myclaims.bme.local/centralclaims/</a>" /&gt; ---- &gt; add the Identifier of the central claims App as the Audience URI of other Apps.</p>
<p>&lt;/audienceUris&gt;</p>
<p>&lt;federatedAuthentication&gt;</p>
<p>&lt;!--Updated to point to centralclaims RP identifier--&gt;</p>
<p>&lt;wsFederation passiveRedirectEnabled="true" issuer="<a href="https://azr.sts.msidentity.com/adfs/ls/">https://azr.sts.msidentity.com/adfs/ls/</a>" realm="<a href="https://myclaims.bme.local/centralclaims/">https://myclaims.bme.local/centralclaims/</a>" requireHttps="true" /&gt;</p>
<p>&lt;cookieHandler requireSsl="true" /&gt;</p>
<p>&lt;/federatedAuthentication&gt;</p>
<ol start="5">
<li>Now browse to central App with query param like this -</li>
</ol>
<p>"<a href="https://myclaims.bme.local/centralclaims/?RelyingParty=prod">https://myclaims.bme.local/centralclaims/?RelyingParty=prod</a>" --- &gt; this will be validated against Request.QueryString["RelyingParty"]; In the Default.aspx.cs of the central App and then Authenticated to appropriate RP. <a href="https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fmyclaims.bme.local%2Fcapass%2F&amp;data=02%7C01%7Ctapand%40microsoft.com%7Cad40ea0f11d049d0ba4b08d7eb89f65f%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637236850085932589&amp;sdata=g4%2Fsd8ekMPlfEaZ7YJxvtk5h7w7hGVfGwSkZB4gx38U%3D&amp;reserved=0">https://myclaims.bme.local/capass/</a> in this case.</p>
<p>"<a href="https://myclaims.bme.local/centralclaims/?RelyingParty=stage">https://myclaims.bme.local/centralclaims/?RelyingParty=stage</a>" --- &gt; this will be validated against Request.QueryString["RelyingParty"]; In the Default.aspx.cs of the central App and then Authenticated to appropriate RP.</p>
<p><a href="https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fmyclaims.bme.local%2FclaimsApp2%2F&amp;data=02%7C01%7Ctapand%40microsoft.com%7Cad40ea0f11d049d0ba4b08d7eb89f65f%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637236850085932589&amp;sdata=hCjNSvDv1y3Q%2Buk%2FYA%2FIPSA7eC1UzXkXYjqIoCPbQkk%3D&amp;reserved=0">https://myclaims.bme.local/claimsApp2/</a> in this case.</p>
